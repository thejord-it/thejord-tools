name: Build and Deploy to K3s

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Uses self-hosted runner on local network
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Deploy to K3s (direct access via self-hosted runner)
        run: |
          # Runner has direct access to K3s on local network

          # Create imagePullSecret on K3s
          ssh -o StrictHostKeyChecking=no root@192.168.1.212 <<'ENDSSH'
            # Create namespace if doesn't exist
            kubectl create namespace thejord --dry-run=client -o yaml | kubectl apply -f -

            # Create/update imagePullSecret for GHCR
            kubectl create secret docker-registry ghcr-secret \
              --docker-server=${{ env.REGISTRY }} \
              --docker-username=${{ github.actor }} \
              --docker-password=${{ secrets.GITHUB_TOKEN }} \
              --namespace=thejord \
              --dry-run=client -o yaml | kubectl apply -f -

            # Apply deployment with new image
            cat <<EOF | kubectl apply -f -
            ---
            apiVersion: v1
            kind: Namespace
            metadata:
              name: thejord

            ---
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: thejord
              namespace: thejord
              labels:
                app: thejord
            spec:
              replicas: 2
              selector:
                matchLabels:
                  app: thejord
              template:
                metadata:
                  labels:
                    app: thejord
                  annotations:
                    # Force rolling update on every deploy
                    deploytime: "$(date +%s)"
                spec:
                  containers:
                  - name: thejord
                    image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                    imagePullPolicy: Always
                    ports:
                    - containerPort: 80
                      name: http
                      protocol: TCP
                    resources:
                      requests:
                        memory: "64Mi"
                        cpu: "100m"
                      limits:
                        memory: "128Mi"
                        cpu: "200m"
                    livenessProbe:
                      httpGet:
                        path: /
                        port: 80
                      initialDelaySeconds: 10
                      periodSeconds: 30
                      timeoutSeconds: 5
                    readinessProbe:
                      httpGet:
                        path: /
                        port: 80
                      initialDelaySeconds: 5
                      periodSeconds: 10
                      timeoutSeconds: 3
                  imagePullSecrets:
                  - name: ghcr-secret

            ---
            apiVersion: v1
            kind: Service
            metadata:
              name: thejord-service
              namespace: thejord
              labels:
                app: thejord
            spec:
              type: NodePort
              ports:
              - port: 80
                targetPort: 80
                nodePort: 30700
                protocol: TCP
                name: http
              selector:
                app: thejord

            ---
            apiVersion: networking.k8s.io/v1
            kind: Ingress
            metadata:
              name: thejord-ingress
              namespace: thejord
              annotations:
                kubernetes.io/ingress.class: "traefik"
                cert-manager.io/cluster-issuer: "letsencrypt-prod"
                traefik.ingress.kubernetes.io/router.middlewares: "default-compress@kubernetescrd"
            spec:
              rules:
              - host: thejord.it
                http:
                  paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: thejord-service
                        port:
                          number: 80
              tls:
              - hosts:
                - thejord.it
                secretName: thejord-tls
            EOF

            # Wait for rollout
            kubectl rollout status deployment/thejord -n thejord --timeout=5m

            # Check deployment
            kubectl get pods -n thejord
            kubectl get svc -n thejord
            kubectl get ingress -n thejord
          ENDSSH

      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Site: https://thejord.it"
          echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
